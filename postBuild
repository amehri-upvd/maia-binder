#!/bin/bash
set -euo pipefail

# Activate the Conda environment
source /opt/conda/bin/activate base

# Install system dependencies if apt.txt exists
if [ -f apt.txt ]; then
  apt-get update && xargs -a apt.txt apt-get install -y --no-install-recommends
fi

# Clone MAIA
git clone https://github.com/onera/Maia

cd Maia

# Create and configure the build directory
mkdir -p build
cd build

# Configure CMake
cmake ../ \
  -DCMAKE_INSTALL_PREFIX="$CONDA_PREFIX" \
  -DCMAKE_CXX_STANDARD=17 \
  -DCMAKE_BUILD_TYPE=Release \
  -DPYTHON_EXECUTABLE=$(which python) \
  ..

# Build with parallel processing
make -j

# Install
make install

# Set the PYTHONPATH (Critically Important!)
MAIA_PYTHON_PATH="$CONDA_PREFIX/lib/python3.10/site-packages"  

if [ ! -d "$MAIA_PYTHON_PATH" ]; then
  echo "Error: Maia Python modules not found at $MAIA_PYTHON_PATH"
  exit 1
fi

echo "export PYTHONPATH=$MAIA_PYTHON_PATH:$PYTHONPATH" >> /home/jovyan/.bashrc
source /home/jovyan/.bashrc   # Make sure the shell uses the updated .bashrc in this script

# Copy Maia to the working directory (optional, but good for exploring source)
cp -r Maia /home/jovyan/

# Check numpy
conda list numpy
