#!/bin/bash
set -e

# Logging helpers
log_info() { echo -e "[INFO] $*"; }
log_error() { echo -e "[ERROR] $*" >&2; }

log_info "Cloning MAIA repository..."
git clone https://github.com/onera/Maia
cd Maia

log_info "Initializing submodules..."
git submodule update --init

log_info "Creating build directory..."
mkdir -p build && cd build

log_info "Setting up virtual environment..."
python3 -m venv maia-venv
source maia-venv/bin/activate

log_info "Upgrading pip and installing NumPy..."
pip install --upgrade pip
pip install numpy

echo "Installing mpi4py in notebook environment..."
pip install --quiet mpi4py

echo "Installing mpi4py in Maia virtualenv if it exists..."
if [ -x /home/jovyan/Maia/build/maia-venv/bin/python ]; then
    /home/jovyan/Maia/build/maia-venv/bin/python -m pip install --quiet mpi4py
else
    echo "maia-venv not found, skipping."
fi

# Avant le CMake
PYTHON_EXECUTABLE="$(pwd)/maia-venv/bin/python"
PYTHON_INCLUDE_DIR=$(${PYTHON_EXECUTABLE} -c "import sysconfig; print(sysconfig.get_path('include'))")
NUMPY_INCLUDE_DIR=$(${PYTHON_EXECUTABLE} -c "import numpy; print(numpy.get_include())")

log_info "Configuring project with CMake..."
cmake ../ \
  -DCMAKE_INSTALL_PREFIX="$(pwd)/../Dist" \
  -DCMAKE_CXX_STANDARD=17 \
  -DCMAKE_BUILD_TYPE=Release \
  -DPython_EXECUTABLE="${PYTHON_EXECUTABLE}" \
  -DPython_INCLUDE_DIRS="${PYTHON_INCLUDE_DIR}" \
  -DPython_NumPy_INCLUDE_DIRS="${NUMPY_INCLUDE_DIR}" \
  -DPython_NumPy_VERSION=2.2.4 \
  -DPython_NumPy=ON

log_info "Python used: $(${PYTHON_EXECUTABLE} --version)"


log_info "Building MAIA..."
make -j$(nproc)

log_info "Installing MAIA..."
make install

log_info "Adding MAIA library to PYTHONPATH..."
echo "export PYTHONPATH=\$PYTHONPATH:$(pwd)/../Dist/lib" >> ~/.bashrc
echo "$(pwd)/../Dist/lib" > /home/jovyan/.pythonpath

log_info "Done!"
