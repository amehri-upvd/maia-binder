#!/bin/bash

# Clone MAIA without initializing submodules
git clone https://github.com/onera/Maia
cd Maia

# Initialize direct submodules only, avoiding recursive initialization
git submodule update --init 2>&1 || { echo "Erreur lors de l'initialisation des sous-modules" >&2; exit 1; }

# Proceed with build
mkdir -p build
cd build

source /srv/conda/etc/profile.d/conda.sh
conda activate notebook

# Configure with proper Python paths
PY_VER=$(python -c "import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}')")
cmake ../ \
  -DCMAKE_INSTALL_PREFIX="$CONDA_PREFIX" \
  -DCMAKE_C_COMPILER=$(which mpicc) \
  -DCMAKE_CXX_COMPILER=$(which mpicxx) \
  -DCMAKE_CXX_STANDARD=17 \
  -DPython_EXECUTABLE="$CONDA_PREFIX/bin/python" \
  -DPython3_NumPy_INCLUDE_DIRS="$CONDA_PREFIX/lib/python$PY_VER/site-packages/numpy/core/include" \
  -DCMAKE_BUILD_TYPE=Release

make -j 
make install

# Add to PYTHONPATH for notebook access
echo "export PYTHONPATH=\$PYTHONPATH:$(pwd)/../Dist/lib" >> /home/jovyan/.bashrc

source /home/jovyan/.bashrc   # Make sure the shell uses the updated .bashrc in this script

# Copy Maia to the working directory (optional, but good for exploring source)
cp -r Maia /home/jovyan/

